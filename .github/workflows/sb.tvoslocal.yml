name: SB - tvOS - Local

on:
  workflow_call: 
    inputs:
      development_build:
        description: 'Development Build'
        type: string
        default: 'false'
      bundle_id:
        description: 'Bundle ID to use'
        type: string
        default: ""
      apple_id:
        description: 'Apple id of the clients store page'
        type: string
        default: ""
      destination:
        description: 'Destination of build'
        type: string
        default: "AppCenter"
      offset_version_number:
        description: 'Offset Version Number Amount'
        type: string
        default: "0"
      export_xcode_project:
        description: 'Export xCode project after build'
        type: string
        default: 'false'
      build_platform:
        description: 'The platform that this build runs on'
        type: string
        default: 'self-hosted'
      unity_path:
        description: 'The path to Unity'
        type: string
        default: '/Applications/Unity/Hub/Editor/2022.3.35f1/Unity.app/Contents/MacOS/Unity'

jobs:
  buildFortvOS:
    name: Build tvOS Project
    runs-on: self-hosted
    steps:

      - name: Checkout Git repo for project
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          path: 'tvOS'
          submodules: recursive
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0
          clean: false
      
      - name: Setup Unity License
        run: |
          ${{ inputs.unity_path }} -quit -batchmode -serial ${{ secrets.UNITY_SERIAL }} -username '${{ secrets.UNITY_EMAIL }}' -password '${{ secrets.UNITY_PASSWORD }}'

      - name: Delete XCode Derrived Data
        run : |
          rm -rf ~/Library/Developer/Xcode/DerivedData

      - name: Delete XCode Archives
        run : |
          rm -rf ~/Library/Developer/Xcode/Archives

      - name: Delete prior test results
        run : |
          rm -rf ./tvOS/Tests

      - name: Delete xcode project
        run : |
          rm -rf ./tvOS/Build

      - name: Run tvOS editor tests
        continue-on-error: true
        run: |
          ${{ inputs.unity_path }} -runTests -batchmode -nographics -projectPath ./tvOS -testResults ./Tests/tvOS/results.xml -buildTarget tvOS -testPlatform EditMode

      - name: tvOS Test Report
        uses: dorny/test-reporter@main
        id: tvOS_test_results
        if: ${{ always() }} && ${{ hashFiles('./tvOS/Tests/tvOS/results.xml') != '' }}
        with:
          name: tvOS Playmode Tests           # Name of the check run which will be created
          path: ./Tests/tvOS/results.xml   # Path to test results
          reporter: dotnet-nunit        # Format of test results
          working-directory: tvOS

      - name: Upload Test Results
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: tvOS Test Results
          path: ./tvOS/Tests/tvOS/results.xml

      - name: Notify Teams
        if: ${{ always() && steps.tvOS_test_results.outputs.conclusion == 'success' && steps.tvOS_test_results.outputs.passed > 0 }} 
        run: |
           cat << EOF > message.json
           {"@type":"MessageCard","@context":"https://schema.org/extensions","summary":"$GITHUB_REPOSITORY tvOS tests passed!","themeColor":"00ff00","title":"$GITHUB_REPOSITORY tvOS tests passed!","sections":[{"facts":[{"name": "Tests Passed", "value":"${{ steps.tvOS_test_results.outputs.passed }}"}, {"name": "Tests Failed", "value":"${{ steps.tvOS_test_results.outputs.failed }}"}, {"name": "Tests Skipped", "value":"${{ steps.tvOS_test_results.outputs.skipped }}"}, {"name": "Test execution time", "value":"${{ steps.tvOS_test_results.outputs.time }}"},{"name":"Branch:","value":"$GITHUB_REF_NAME"}]}],"potentialAction":[{"@type":"OpenUri","name":"View on GitHub","targets":[{"os":"default","uri":"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"}]}]}
           EOF
           curl -X POST ${{ secrets.MSTEAMS_WEBHOOK }} --header 'Content-Type: application/json' -d @message.json

      - name: Notify Teams
        if: ${{ always() && steps.tvOS_test_results.outputs.conclusion == 'failure' || steps.tvOS_test_results.outputs.passed == 0}} 
        run: |
           cat << EOF > message.json
           {"@type":"MessageCard","@context":"https://schema.org/extensions","summary":"$GITHUB_REPOSITORY tvOS tests failed!","themeColor":"ff0000","title":"$GITHUB_REPOSITORY tvOS tests failed!","sections":[{"facts":[{"name": "Tests Passed", "value":"${{ steps.tvOS_test_results.outputs.passed }}"}, {"name": "Tests Failed", "value":"${{ steps.tvOS_test_results.outputs.failed }}"}, {"name": "Tests Skipped", "value":"${{ steps.tvOS_test_results.outputs.skipped }}"}, {"name": "Test execution time", "value":"${{ steps.tvOS_test_results.outputs.time }}"},{"name":"Branch:","value":"$GITHUB_REF_NAME"}]}],"potentialAction":[{"@type":"OpenUri","name":"View on GitHub","targets":[{"os":"default","uri":"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"}]}]}
           EOF
           curl -X POST ${{ secrets.MSTEAMS_WEBHOOK }} --header 'Content-Type: application/json' -d @message.json

      - shell: bash
        if: ${{ always() && steps.tvOS_test_results.outputs.conclusion == 'success' && steps.tvOS_test_results.outputs.passed > 0 }} 
        id: version_code
        run: |
          cd ${GITHUB_WORKSPACE}/tvOS
          count=$(git rev-list --count HEAD)
          echo "Current count is ${count}"

          current_branch=$(git rev-parse --abbrev-ref HEAD)
          echo "Current branch is ${current_branch}"
          echo "::set-output name=code::$count"

      - shell: bash
        if: ${{ always() && steps.tvOS_test_results.outputs.conclusion == 'success' && steps.tvOS_test_results.outputs.passed > 0 }} 
        run: |
          echo ${{ steps.version_code.outputs.code }}
          echo ${{ steps.version_code.outputs.code }} > buildNumber.txt

      - name: Build tvOS project
        if: ${{ always() && steps.tvOS_test_results.outputs.conclusion == 'success' && steps.tvOS_test_results.outputs.passed > 0 }} 
        continue-on-error: true
        run: |
          ${{ inputs.unity_path }} -batchmode -nographics -projectPath ./tvOS -buildTarget tvOS -executeMethod ScaryBeasties.BuildSettings.Builder.BuildSettings.CommandLineBuild -platform tvOS -development ${{ inputs.development_build }} -bundle_id ${{ inputs.bundle_id }} -project_name ${{ github.event.repository.name }} -addressables_profile 'Default' -build_number ${{ steps.version_code.outputs.code }} -build_number_offset '0' -customBuildPath 'Build/tvOS'

      - name: Checkout Fastlane 
        if: ${{ always() && steps.tvOS_test_results.outputs.conclusion == 'success' || steps.tvOS_test_results.outputs.passed == 0}} 
        uses: actions/checkout@v4
        with:
          repository: scarybeasties/Fastlane
          token: ${{ secrets.GH_PAT }}
          ref: main
          path: ./fastlane

      - name: Checkout Certs
        if: ${{ always() && steps.tvOS_test_results.outputs.conclusion == 'success' || steps.tvOS_test_results.outputs.passed == 0}}
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.MATCH_REPOSITORY }}
          token: ${{ secrets.GH_PAT }}
          ref: main
          path: ./certs

      - name: Build to AppCenter
        if: ${{ always() && inputs.destination == 'AppCenter' && steps.tvOS_test_results.outputs.conclusion == 'success' || steps.tvOS_test_results.outputs.passed == 0}} 
        env:
          APPLE_CONNECT_EMAIL: ${{ secrets.APPLE_CONNECT_EMAIL }}
          APPLE_DEVELOPER_EMAIL: ${{ secrets.APPLE_DEVELOPER_EMAIL }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

          SB_CERTIFICATE_PASSWORD: ${{ secrets.SB_CERTIFICATE_PASSWORD }}

          MATCH_DEPLOY_KEY: ${{ secrets.MATCH_DEPLOY_KEY }}
          MATCH_REPOSITORY: ${{ secrets.MATCH_REPOSITORY }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}

          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_P8: ${{ secrets.APPSTORE_P8 }}

          APPCENTER_API_TOKEN: ${{ secrets.APPCENTER_API_TOKEN }}
          APPCENTER_OWNER: ${{ secrets.APPCENTER_OWNER }}

          BUILD_PATH: ${{ format('{0}/tvOS/build', github.workspace) }}
          BUNDLE_ID: ${{ inputs.bundle_id }}
          PROJECT_NAME: ${{ github.event.repository.name }}

        run: |
          pwd
          eval "$(ssh-agent -s)"
          ssh-add - <<< "${MATCH_DEPLOY_KEY}"
          find $BUILD_PATH -type f -name "**.sh" -exec chmod +x {} \;
          cd fastlane
          gem install bundler:2.4.6
          bundle install
          bundle exec fastlane tvOS BuildAppCenter

      - name: Build to testflight
        if: ${{ always() && inputs.destination == 'SB Testflight' && steps.tvOS_test_results.outputs.conclusion == 'success' || steps.tvOS_test_results.outputs.passed == 0}} 
        env:
          APPLE_CONNECT_EMAIL: ${{ secrets.APPLE_CONNECT_EMAIL }}
          APPLE_DEVELOPER_EMAIL: ${{ secrets.APPLE_DEVELOPER_EMAIL }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

          SB_CERTIFICATE_PASSWORD: ${{ secrets.SB_CERTIFICATE_PASSWORD }}

          MATCH_DEPLOY_KEY: ${{ secrets.MATCH_DEPLOY_KEY }}
          MATCH_REPOSITORY: ${{ secrets.MATCH_REPOSITORY }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}

          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_P8: ${{ secrets.APPSTORE_P8 }}

          APPCENTER_API_TOKEN: ${{ secrets.APPCENTER_API_TOKEN }}
          APPCENTER_OWNER: ${{ secrets.APPCENTER_OWNER }}

          BUILD_PATH: ${{ format('{0}/tvOS/build', github.workspace) }}
          BUNDLE_ID: ${{ inputs.bundle_id }}
          PROJECT_NAME: ${{ github.event.repository.name }}

          BUILD_NUMBER: ${{ steps.version_code.outputs.code }}
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }} 

        run: |
          pwd
          eval "$(ssh-agent -s)"
          ssh-add - <<< "${MATCH_DEPLOY_KEY}"
          find $BUILD_PATH -type f -name "**.sh" -exec chmod +x {} \;
          cd fastlane
          bundle install
          bundle exec fastlane iOS BuildSBTestFlight

      - name: Notify Teams
        if: ${{ success() && inputs.destination == 'AppCenter' }}
        run: |
           cat << EOF > message.json
           {"@type":"MessageCard","@context":"https://schema.org/extensions","summary":"tvOS AppCenter Build Deployed!","themeColor":"00ff00","title":"$GITHUB_REPOSITORY tvOS AppCenter Build Deployed! 🤖","sections":[{"facts":[{"name":"Build Number", "value":"${{ steps.version_code.outputs.code }}"},{"name":"Repository:","value":"$GITHUB_REPOSITORY"},{"name":"Branch:","value":"$GITHUB_REF_NAME"}]}],"potentialAction":[{"@type":"OpenUri","name":"View on GitHub","targets":[{"os":"default","uri":"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"}]}]}
           EOF
           curl -X POST ${{ secrets.MSTEAMS_WEBHOOK }} --header 'Content-Type: application/json' -d @message.json

      - name: Notify Teams
        if: ${{ success() && inputs.destination == 'SB Testflight' }}
        run: |
           cat << EOF > message.json
           {"@type":"MessageCard","@context":"https://schema.org/extensions","summary":"tvOS SB Testflight Build Deployed!","themeColor":"00ff00","title":"$GITHUB_REPOSITORY tvOS SB Testflight Build Deployed! 🚀","sections":[{"facts":[{"name":"Build Number", "value":"${{ steps.version_code.outputs.code }}"},{"name":"Repository:","value":"$GITHUB_REPOSITORY"},{"name":"Branch:","value":"$GITHUB_REF_NAME"}]}],"potentialAction":[{"@type":"OpenUri","name":"View on GitHub","targets":[{"os":"default","uri":"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"}]}]}
           EOF
           curl -X POST ${{ secrets.MSTEAMS_WEBHOOK }} --header 'Content-Type: application/json' -d @message.json
